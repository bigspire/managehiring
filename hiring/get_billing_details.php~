<?php 
/* 
Purpose : To get billing details.
Created : Nikita
Date : 02-02-2017
*/


include 'configs/smartyconfig.php';
// include mysql class
include('classes/class.mysql.php');
// Connecting Database
$mysql->connect_database();
// include function validation class
include('classes/class.function.php');

$resume_id = $_GET['resume_id'];

//get search term
$keyword = $_GET['q'];
if($_GET['page'] == 'add_billing_candidate_search'){
	// get matched data from joined candidate
	$query = "CALL get_billing_candidate_name('".$keyword."')";
	try{	
		if(!$result = $mysql->execute_query($query)){
			throw new Exception('Problem in executing add billing page');
		}
		// iterate until get the matched results
		while($obj = $mysql->display_result($result)){
			$data[$obj['id']] = ucwords($fun->match_results($keyword,$obj['first_name']).' '.$obj['last_name'].' '.$obj['email_id'].' '.$obj['mobile']);	
			/*$data[] = strtolower($fun->match_results($keyword,$obj['last_name']));
			$data[] = strtolower($fun->match_results($keyword,$obj['email_id']));
			$data[] = strtolower($fun->match_results($keyword,$obj['mobile']));	*/
		}
		
		// filter the duplicate values
		$unique_result = array_unique($data);	
		// display the search results
		foreach($unique_result as $res){
			if(!empty($res)){ 
				$unique[] = $res;
			}
		}
		// free the memory
		$mysql->clear_result($result);		
   }catch(Exception $e){
		echo 'Caught exception: ',  $e->getMessage(), "\n";
   }
}
// convert court name
$query ="CALL get_courtname_byid('".$court_id."')";
try{
	// calling mysql exe_query function
	if(!$result = $mysql->execute_query($query)){
		throw new Exception('Problem in executing section page');
	}
	$dt = $mysql->display_result($result);
	$courtname = $dt['court_name'];	
	// free the memory
	//$mysql->clear_result($result);
	// call the next result
	$mysql->next_query();
}catch(Exception $e){
	echo 'Caught exception: ',  $e->getMessage(), "\n";
}
if($resume_id != ''){
	// get billing details
	$query ="CALL get_billing('".$resume_id."')";

	try{
		// calling mysql exe_query function
		if(!$result = $mysql->execute_query($query)){
			throw new Exception('Problem in executing billing page');
		}
   	$i = '0'; 
		while($obj = $mysql->display_result($result)){
 			$data[] = $obj;
	  	 	$data[$i]['position'] = ucwords($obj['position']);
	   	$data[$i]['client'] = ucwords($obj['client']);
	  	 	$data[$i]['ctc_offer'] = ucwords($obj['ctc_offer']);
	   	$data[$i]['billing_amount'] = ucwords($obj['billing_amount']);
	   	$data[$i]['billing_date'] = ucwords($obj['billing_date']);
	   	$data[$i]['joined_date'] = ucwords($obj['joined_date']);
			$i++;
		}	
		// free the memory
		$mysql->clear_result($result);
	}catch(Exception $e){
		echo 'Caught exception: ',  $e->getMessage(), "\n";
	}
}
//print_r($data);
if($data != ''){
	echo json_encode($data);
}else {
	$data ='';
	echo json_encode($data);
}

/*if(!empty($unique)){
	// display the search results
	foreach($unique as $res):
		if(!empty($res)): 
			echo $res."\n";
		endif;
	endforeach;
}else{
	echo $no_data = 'No Results!';
	// echo json_encode($no_data); 
}*/

// closing mysql
$mysql->close_connection();	  
?>